#!/bin/tclsh

# runtimer parameter, line 38; HDB docs: The timer will return when vucomplete returns true or the timer reaches the seconds value.
# Calculation basis: "runtimer must be longer than rampup + duration"
# TPM is first measured on the rampup minute and then after duration minutes, VUs run until runtimer or until they end
# https://github.com/TPC-Council/HammerDB/discussions/84
# Run should finish in less time anyways if duration passes, not necessarily taking "runtimer" time, *2 should be enough
# It was set to 1.5 on one of our own repositories and hardcoded to low values in the other - *6 because of db snapshots taken while testing

proc runtimer { seconds } {
  set x 0
  set timerstop 0
    while {!$timerstop} {
      incr x
      after 1000
        if { ![ expr {$x % 60} ] } {
          set y [ expr $x / 60 ]
          puts "Timer: $y minutes elapsed"
        }
      update
      if {  [ vucomplete ] || $x eq $seconds } { set timerstop 1 }
    }
  return
}
puts "SETTING CONFIGURATION"
dbset db ora
diset connection instance {{ oracle.service_name }}
diset tpcc count_ware {{ warehouses }}
diset tpcc num_vu {{ v_users }}
vuset logtotemp 1
loadscript
puts "SEQUENCE STARTED"
foreach z { {{ v_users }} } {
  puts "$z VU TEST"
  vuset vu $z
  vucreate
  vurun
  runtimer {{ ((rampup_duration | int) + (test_duration | int)) * 60 * 2 }}
  vudestroy
  after 5000
}
puts "TEST SEQUENCE COMPLETE"
